# Supabase Caddy Configuration
# Caddy automatically obtains and renews SSL certificates via Let's Encrypt
#
# Installation:
#   1. Install Caddy:
#      sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
#      curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
#      curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
#      sudo apt update
#      sudo apt install caddy
#
#   2. Copy this file:
#      sudo cp Caddyfile /etc/caddy/Caddyfile
#
#   3. Update domain name below (replace api.yourdomain.com)
#
#   4. Start Caddy:
#      sudo systemctl start caddy
#      sudo systemctl enable caddy
#
# Advantages over Nginx:
#   - Automatic HTTPS certificate management
#   - Automatic certificate renewal
#   - Simpler configuration syntax
#   - HTTP/3 support by default
#
# IMPORTANT: Replace 'api.yourdomain.com' with your actual domain name

# Main Supabase API endpoint
api.yourdomain.com {
    # Automatic HTTPS with Let's Encrypt
    # Caddy handles certificate issuance and renewal automatically

    # Reverse proxy to Kong Gateway
    reverse_proxy localhost:8000 {
        # Preserve original headers
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote.host}
        header_up X-Forwarded-For {http.request.remote.host}
        header_up X-Forwarded-Proto {http.request.scheme}
        header_up X-Forwarded-Host {http.request.host}

        # WebSocket support for Supabase Realtime
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}

        # Health check configuration
        health_uri /health
        health_interval 30s
        health_timeout 5s
    }

    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains"

        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"

        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"

        # XSS Protection
        X-XSS-Protection "1; mode=block"

        # Remove server header
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/supabase_access.log
        format json
    }
}

# Optional: Separate domain for frontend/dashboard
# Uncomment and configure if you have a separate frontend domain
#
# app.yourdomain.com {
#     reverse_proxy localhost:3000 {
#         header_up Host {http.request.host}
#         header_up X-Real-IP {http.request.remote.host}
#         header_up X-Forwarded-For {http.request.remote.host}
#         header_up X-Forwarded-Proto {http.request.scheme}
#     }
#
#     header {
#         Strict-Transport-Security "max-age=31536000; includeSubDomains"
#         X-Frame-Options "SAMEORIGIN"
#         X-Content-Type-Options "nosniff"
#     }
# }
