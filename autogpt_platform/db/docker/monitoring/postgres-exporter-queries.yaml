# Custom PostgreSQL queries for postgres_exporter
# Provides Supabase-specific metrics

pg_database:
  query: "SELECT pg_database.datname, pg_database_size(pg_database.datname) as size FROM pg_database"
  master: true
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - size:
        usage: "GAUGE"
        description: "Disk space used by the database"

pg_stat_user_tables:
  query: "SELECT schemaname, relname, seq_scan, seq_tup_read, idx_scan, idx_tup_fetch, n_tup_ins, n_tup_upd, n_tup_del FROM pg_stat_user_tables"
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema"
    - relname:
        usage: "LABEL"
        description: "Name of the table"
    - seq_scan:
        usage: "COUNTER"
        description: "Number of sequential scans"
    - seq_tup_read:
        usage: "COUNTER"
        description: "Number of tuples read by sequential scans"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Number of tuples fetched by index scans"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Number of tuples inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Number of tuples updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Number of tuples deleted"

pg_stat_statements:
  query: "SELECT queryid, query, calls, total_exec_time, mean_exec_time, max_exec_time FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 20"
  master: true
  metrics:
    - queryid:
        usage: "LABEL"
        description: "Query ID"
    - query:
        usage: "LABEL"
        description: "Query text"
    - calls:
        usage: "COUNTER"
        description: "Number of times executed"
    - total_exec_time:
        usage: "COUNTER"
        description: "Total time spent executing"
    - mean_exec_time:
        usage: "GAUGE"
        description: "Mean execution time"
    - max_exec_time:
        usage: "GAUGE"
        description: "Maximum execution time"

pg_replication:
  query: "SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) as lag"
  metrics:
    - lag:
        usage: "GAUGE"
        description: "Replication lag in seconds"

pg_connections:
  query: |
    SELECT
      tmp.state,
      COALESCE(count,0) as count,
      COALESCE(max_tx_duration,0) as max_tx_duration
    FROM (
      VALUES ('active'),
             ('idle'),
             ('idle in transaction'),
             ('idle in transaction (aborted)'),
             ('fastpath function call'),
             ('disabled')
    ) AS tmp(state)
    LEFT JOIN (
      SELECT
        state,
        count(*) AS count,
        MAX(EXTRACT(EPOCH FROM now() - xact_start))::float AS max_tx_duration
      FROM pg_stat_activity
      WHERE state IS NOT NULL
      GROUP BY state
    ) AS tmp2 ON tmp.state = tmp2.state
  metrics:
    - state:
        usage: "LABEL"
        description: "Connection state"
    - count:
        usage: "GAUGE"
        description: "Number of connections in this state"
    - max_tx_duration:
        usage: "GAUGE"
        description: "Max duration of transactions in this state"
