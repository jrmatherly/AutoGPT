name: AutoGPT Platform - Deploy Dev Environment

on:
  push:
    branches: [dev]
    paths:
      - "autogpt_platform/**"
  workflow_dispatch:
    inputs:
      git_ref:
        description: "Git ref (branch/tag) of AutoGPT to deploy"
        required: true
        default: "master"
        type: string

permissions:
  contents: "read"
  id-token: "write"

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: false

jobs:
  migrate:
    environment: develop
    name: Run migrations for AutoGPT Platform
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Run Prisma migrations
        uses: ./.github/actions/prisma-migrate
        with:
          python-version: "3.13"
          database-url: ${{ secrets.BACKEND_DATABASE_URL }}
          git-ref: ${{ github.event.inputs.git_ref || github.ref_name }}

  trigger:
    needs: migrate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger deploy workflow
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}
          repository: Significant-Gravitas/AutoGPT_cloud_infrastructure
          event-type: build_deploy_dev
          client-payload: '{"ref": "${{ github.event.inputs.git_ref || github.ref }}", "repository": "${{ github.repository }}"}'
