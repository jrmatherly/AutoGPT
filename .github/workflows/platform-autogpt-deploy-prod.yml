name: AutoGPT Platform - Deploy Prod Environment

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: "read"
  id-token: "write"

concurrency:
  group: deploy-prod-${{ github.ref }}
  cancel-in-progress: false

jobs:
  migrate:
    environment: production
    name: Run migrations for AutoGPT Platform
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Run Prisma migrations
        uses: ./.github/actions/prisma-migrate
        with:
          python-version: "3.13"
          database-url: ${{ secrets.BACKEND_DATABASE_URL }}
          git-ref: ${{ github.ref_name || 'master' }}

  trigger:
    needs: migrate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger deploy workflow
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}
          repository: Significant-Gravitas/AutoGPT_cloud_infrastructure
          event-type: build_deploy_prod
          client-payload: |
            {"ref": "${{ github.ref_name || 'master' }}", "repository": "${{ github.repository }}"}
